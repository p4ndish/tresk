# Tresk - VPS Security Monitor Configuration File
# Location: /etc/tresk/config.conf
# Last Updated: 2025-02-20

# =============================================================================
# GENERAL SETTINGS
# =============================================================================

# Monitor mode: quick, standard, full
MONITOR_MODE="standard"

# Host identification
HOSTNAME="$(hostname)"
PUBLIC_IP="$(curl -s -m 5 ifconfig.me 2>/dev/null || echo 'unknown')"

# Log settings
LOG_DIR="/var/log/tresk"
LOG_LEVEL="INFO"  # DEBUG, INFO, WARNING, ERROR, CRITICAL
LOG_RETENTION_DAYS=30
ENABLE_JSON_LOGGING="true"

# Working directory
WORK_DIR="/opt/tresk"
SIGNATURE_DB="${WORK_DIR}/signatures/threat_signatures.json"

# =============================================================================
# TELEGRAM SETTINGS
# =============================================================================

# Telegram Bot Configuration
TELEGRAM_ENABLED="true"
TELEGRAM_BOT_TOKEN=""
TELEGRAM_CHAT_ID=""
TELEGRAM_THREAD_ID=""  # Optional: for forum topics

# =============================================================================
# AI ANALYSIS SETTINGS (Kimi K2 Integration)
# =============================================================================

# Enable AI-powered threat analysis to reduce false positives
AI_ANALYSIS_ENABLED="false"

# Kimi API Key - Choose ONE of the following options:
#
# Option 1: Moonshot API (https://platform.moonshot.cn/)
# KIMI_API_KEY="sk-your-moonshot-api-key"
# KIMI_API_URL="https://api.moonshot.cn/v1/chat/completions"
# KIMI_MODEL="kimi-k2-0712-preview"
#
# Option 2: Kimi Code API (https://www.kimi.com/code/console)
# KIMI_API_KEY="sk-your-kimi-code-api-key"
# KIMI_API_URL="https://api.kimi.com/v1/chat/completions"
# KIMI_MODEL="kimi-k2-0712-preview"

KIMI_API_KEY=""
KIMI_API_URL="https://api.moonshot.cn/v1/chat/completions"
KIMI_MODEL="kimi-k2-0712-preview"

# AI Analysis Threshold - minimum confidence to trust AI decision (0.0 - 1.0)
# Higher = more conservative, may miss some threats but fewer false positives
AI_CONFIDENCE_THRESHOLD="0.75"

# AI Analysis Mode:
#   "conservative" - AI must confirm threat before alerting (reduces false positives)
#   "assisted"     - AI analyzes but human decides (logs AI opinion)
#   "disabled"     - No AI analysis (original behavior)
AI_MODE="conservative"

# Alert settings
ALERT_CRITICAL="true"
ALERT_HIGH="true"
ALERT_MEDIUM="true"
ALERT_LOW="false"

# Notification settings
SEND_INSTANT_ALERTS="true"
SEND_DAILY_SUMMARY="true"
SEND_WEEKLY_REPORT="true"
DAILY_SUMMARY_TIME="08:00"
WEEKLY_REPORT_DAY="Sunday"
WEEKLY_REPORT_TIME="09:00"

# Rate limiting (seconds between similar alerts)
# IMPORTANT: Set to at least 300 (5 minutes) to prevent spam
ALERT_COOLDOWN_CRITICAL=300
ALERT_COOLDOWN_HIGH=600
ALERT_COOLDOWN_MEDIUM=1800
ALERT_COOLDOWN_LOW=3600

# =============================================================================
# AUTO-RESPONSE SETTINGS (KILL SWITCH)
# =============================================================================

# Enable automatic response to threats
AUTO_RESPONSE_ENABLED="false"

# Auto-kill settings (use with extreme caution!)
AUTO_KILL_CRITICAL="false"      # Automatically kill critical threat processes
AUTO_KILL_HIGH="false"          # Automatically kill high threat processes
AUTO_BLOCK_IP="false"           # Automatically block attacking IPs

# Process protection whitelist (never kill these)
PROTECTED_PROCESSES="sshd|systemd|dbus|network|cron|rsyslog|journald|auditd"

# IP whitelist (never block these)
IP_WHITELIST="127.0.0.1|::1"

# Emergency mode - maximum protection
EMERGENCY_MODE="false"

# =============================================================================
# MONITORING SETTINGS
# =============================================================================

# Real-time monitoring intervals (seconds)
PROCESS_CHECK_INTERVAL=5
NETWORK_CHECK_INTERVAL=10
FILE_CHECK_INTERVAL=30

# Scan schedules
QUICK_SCAN_INTERVAL=3600      # Every hour
DEEP_SCAN_INTERVAL=86400      # Every day
FULL_AUDIT_INTERVAL=604800    # Every week

# CPU threshold for cryptominer detection (%)
CPU_THRESHOLD=85
CPU_DURATION_THRESHOLD=300    # Seconds of sustained high CPU

# Memory threshold (%)
MEMORY_THRESHOLD=90

# Disk usage threshold (%)
DISK_THRESHOLD=95

# Network connection threshold (number of connections)
NETWORK_CONN_THRESHOLD=1000

# =============================================================================
# FILE INTEGRITY MONITORING
# =============================================================================

# Enable file integrity monitoring
FIM_ENABLED="true"

# Critical files to monitor
CRITICAL_FILES=(
    "/etc/passwd"
    "/etc/shadow"
    "/etc/group"
    "/etc/sudoers"
    "/etc/ssh/sshd_config"
    "/etc/crontab"
    "/etc/hosts"
    "/etc/resolv.conf"
    "/etc/ld.so.preload"
    "/etc/rc.local"
)

# Critical directories to monitor
CRITICAL_DIRS=(
    "/etc/cron.d"
    "/etc/cron.hourly"
    "/etc/cron.daily"
    "/etc/cron.weekly"
    "/etc/cron.monthly"
    "/etc/systemd/system"
    "/etc/init.d"
    "/etc/profile.d"
    "/root/.ssh"
    "/tmp"
    "/var/tmp"
)

# Web directories to scan for shells
WEB_DIRS=(
    "/var/www"
    "/usr/share/nginx"
    "/var/lib/tomcat"
    "/opt/tomcat"
    "/srv/www"
)

# File extensions to monitor for ransomware
RANSOMWARE_EXTENSIONS="\.encrypted$|\.locked$|\.crypto$|\.crypt$|\.vault$|\.ransom$|\.enc$"

# =============================================================================
# PROCESS MONITORING
# =============================================================================

# Enable process monitoring
PROCESS_MONITORING="true"

# Monitor for deleted executables
DETECT_DELETED_PROCESSES="true"

# Monitor for hidden processes
DETECT_HIDDEN_PROCESSES="true"

# Monitor LD_PRELOAD
DETECT_LD_PRELOAD="true"

# Suspicious process patterns
SUSPICIOUS_PATTERNS=(
    "base64 -d|base64 --decode"
    "eval\s*\("
    "exec\s*\("
    "system\s*\("
    "passthru\s*\("
    "shell_exec\s*\("
    "popen\s*\("
    "proc_open\s*\("
    "curl.*\|.*bash"
    "wget.*\|.*bash"
    "fetch.*\|.*sh"
)

# =============================================================================
# NETWORK MONITORING
# =============================================================================

# Enable network monitoring
NETWORK_MONITORING="true"

# Monitor for suspicious ports
SUSPICIOUS_PORTS=(4444 5555 6666 7777 8888 9999 31337 12345 54321 9876 11111)

# Known malicious IPs (additional to signatures)
BLOCKLIST_URLS=(
    "https://raw.githubusercontent.com/stamparm/ipsum/master/ipsum.txt"
    "https://raw.githubusercontent.com/firehol/blocklist-ipsets/master/firehol_level1.netset"
)

# DNS monitoring
DNS_MONITORING="true"
SUSPICIOUS_DNS_DOMAINS="\.onion$|\.i2p$|tor2web\\."

# =============================================================================
# CONTAINER SECURITY
# =============================================================================

# Enable container security monitoring
CONTAINER_SECURITY="true"

# Docker socket path
DOCKER_SOCKET="/var/run/docker.sock"

# Monitor for privileged containers
DETECT_PRIVILEGED_CONTAINERS="true"

# Monitor for container escapes
DETECT_CONTAINER_ESCAPES="true"

# Kubernetes monitoring
KUBERNETES_MONITORING="false"
KUBE_CONFIG="/root/.kube/config"

# =============================================================================
# SSH SECURITY
# =============================================================================

# Enable SSH monitoring
SSH_MONITORING="true"

# Brute force detection
BRUTE_FORCE_THRESHOLD=5
BRUTE_FORCE_WINDOW=300  # 5 minutes

# Monitor authorized_keys
MONITOR_AUTHORIZED_KEYS="true"

# Alert on root login
ALERT_ROOT_LOGIN="true"

# =============================================================================
# SYSTEM SECURITY
# =============================================================================

# Enable system security checks
SYSTEM_SECURITY="true"

# Check for SUID binaries
SUID_CHECK="true"
SUID_WHITELIST="\/usr\/bin\/passwd|\/usr\/bin\/sudo|\/usr\/bin\/su|\/usr\/bin\/mount|\/usr\/bin\/umount|\/usr\/bin\/chsh|\/usr\/bin\/chfn|\/usr\/bin\/newgrp|\/usr\/bin\/gpasswd|\/usr\/bin\/pkexec|\/usr\/bin\/screen|\/usr\/bin\/tmux"

# Check for world-writable files
WORLD_WRITABLE_CHECK="true"

# Check for unowned files
UNOWNED_FILES_CHECK="true"

# Kernel module monitoring
KERNEL_MODULE_MONITORING="true"

# =============================================================================
# EXTERNAL TOOLS INTEGRATION
# =============================================================================

# Enable integration with external security tools
EXTERNAL_TOOLS="true"

# RKHunter settings
RKHUNTER_ENABLED="true"
RKHUNTER_PATH="/usr/bin/rkhunter"
RKHUNTER_FLAGS="--check --sk"

# Chkrootkit settings
CHKROOTKIT_ENABLED="true"
CHKROOTKIT_PATH="/usr/sbin/chkrootkit"

# AIDE settings
AIDE_ENABLED="true"
AIDE_PATH="/usr/bin/aide"
AIDE_CONFIG="/etc/aide/aide.conf"

# Auditd settings
AUDITD_ENABLED="true"
AUDITD_PATH="/sbin/auditctl"

# ClamAV settings
CLAMAV_ENABLED="false"
CLAMAV_PATH="/usr/bin/clamscan"
CLAMAV_FLAGS="--infected --recursive"

# Lynis settings
LYNIS_ENABLED="true"
LYNIS_PATH="/usr/bin/lynis"
LYNIS_FLAGS="audit system --quick"

# =============================================================================
# PERFORMANCE SETTINGS
# =============================================================================

# CPU limit for monitoring processes (%)
CPU_LIMIT=10

# Memory limit for monitoring processes (MB)
MEMORY_LIMIT=100

# Nice level for monitoring processes
NICE_LEVEL=10

# I/O scheduling class
IONICE_CLASS=2
IONICE_PRIORITY=7

# =============================================================================
# BACKUP AND RECOVERY
# =============================================================================

# Backup critical files before modification
BACKUP_ENABLED="true"
BACKUP_DIR="/var/backups/tresk"
BACKUP_RETENTION_DAYS=7

# =============================================================================
# TESTING AND DEBUGGING
# =============================================================================

# Test mode (send alerts to test channel)
TEST_MODE="false"

# Verbose output
VERBOSE="false"

# Dry run (detect but don't act)
DRY_RUN="false"

# Debug mode
DEBUG="false"
